{% extends "base.html" %}
{% load static %}
{% block title %}Gallery - Aesthetics{% endblock %}

{% block content %}
  <h1 class="text-3xl font-semibold mb-6 text-center">✨ Aesthetics Catalog</h1>

<!-- refresh signal target -->
  <div id="gallery">
    <div class="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
      {% for file in files %}
        <div class="rounded shadow bg-white p-2 flex flex-col">
          <img src="{{ MEDIA_URL }}{{ file.name }}"
               alt="{{ file.name }}"
               class="aspect-square object-cover rounded">

          <button
            hx-get="{% url 'visor:edit' file.name %}"
            hx-target="#modal"
            hx-swap="innerHTML"
            class="mt-3 py-1.5 rounded bg-indigo-600 hover:bg-indigo-700 text-white text-sm transition">
            {% if file.name in existing %}✏️ Edit{% else %}➕ Add metadata{% endif %}
          </button>
        </div>
      {% endfor %}
    </div>
  </div>
  <div id="modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center"></div>

  <script>
      /* Toggle modal visibility when content is injected */
    document.body.addEventListener("htmx:afterOnLoad", (evt) => {
      if (evt.detail.target.id === "modal") {
        document.getElementById("modal").classList.remove("hidden");
      }
    });
      /* Hide modal on successful POST (status 200 + 'OK') */
    document.body.addEventListener("htmx:afterSwap", (evt) => {
      if (e.detail.target.id === "modal") {
        djangoSelect2.initializeAll();
      }
      else if (evt.detail.target.id === "modal" && evt.detail.xhr.status === 200 &&
        evt.detail.xhr.responseText === "OK") {
          evt.detail.target.innerHTML = "";
          document.getElementById("modal").classList.add("hidden");
          /* trigger gallery refresh */
          htmx.trigger(htmx.find("#gallery"), "refresh");
        }
    });
  </script>
{% endblock %}
