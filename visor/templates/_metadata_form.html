{% load static %}
{% load django_bootstrap5 %}

<!-- Full Bootstrap modal so we get backdrop, ESC‑to‑close and centering -->
<div class="modal fade show d-block" id="metaModal" tabindex="-1"
     style="background-color:rgba(0,0,0,.65);" aria-modal="true" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl">
    <div class="modal-content border-0 shadow-lg">
      <!-- header ---------------------------------------------------------- -->
      {{ form.media }}
      <div class="modal-header bg-primary bg-gradient text-white py-2">
        <h5 class="modal-title fw-semibold small mb-0">
          Edit metadata · <code>{{ filename }}</code>
        </h5>
      </div>
      <!-- form ------------------------------------------------------------ -->
      <form hx-post="{% url 'visor:edit' filename %}" hx-target="#modal" hx-swap="outerHTML" class="needs-validation" novalidate>
        {% csrf_token %}
        <div class="modal-body py-3">
          <div class="container-fluid">
            <div class="row g-4">
              <!-- left column -->
              <div class="col-md-6">
                {% bootstrap_field form.title size='sm' %}
                {% bootstrap_field form.author size='sm' %}
                <div class="row g-2">
                  <div class="col-6">
                    {% bootstrap_field form.year size='sm' %}
                  </div>
                  <div class="col-6">
                    {% bootstrap_field form.museum size='sm' %}
                  </div>
                </div>
                {% bootstrap_field form.material size='sm' %}
              </div>

              <!-- right column -->
              <div class="col-md-6">
                <div class="mb-3">
                  {% bootstrap_field form.tags size='sm' %}
                </div>
                {% bootstrap_field form.description rows=5 size='sm' %}
                {% bootstrap_field form.source placeholder='https://example.com' size='sm' %}
              </div>
            </div>
          </div>
        </div>

        <!-- footer -->
        <div class="modal-footer bg-light py-2">
          <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success btn-sm px-4">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Escape key closes modal
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      const modal = document.getElementById('modal');
      if (modal) {
        modal.classList.add('hidden');
        modal.innerHTML = '';
      }
    }
  });

  // Retry until djangoSelect2 is defined
  function tryInitSelect2() {
    if (typeof djangoSelect2 !== 'undefined') {
      djangoSelect2.initializeAll();
    } else {
      setTimeout(tryInitSelect2, 50);
    }
  }

  // Call it immediately (not on DOMContentLoaded!)
  tryInitSelect2();
</script>
